name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  PYTHON_VERSION: '3.13'

jobs:
  test:
    name: Test on ${{ matrix.os }} - Python ${{ matrix.python-version }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ['3.13']

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install uv
      uses: astral-sh/setup-uv@v6
      with:
        enable-cache: true
        cache-dependency-glob: |
          **/pyproject.toml
          **/uv.lock
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies
      run: uv sync --dev

    - name: Check packages can be imported
      run: |
        uv run python -c "from ai_task_notify_hook.cli import main; print('CLI module imported')"
        uv run python -c "from ai_task_notify_hook.config import load_config; print('Config module imported')"
        uv run python -c "from ai_task_notify_hook.logging import configure_logging; print('Logging module imported')"

    - name: Test configuration system
      run: |
        uv run python -c "
        from ai_task_notify_hook.config import load_config, validate_config_file
        print('Testing configuration system...')
        try:
            config = load_config()
            print(f'Config loaded: timeout={config.notification.timeout}')
            is_valid = validate_config_file()
            print(f'Config validation: {is_valid}')
            print('Configuration system working')
        except Exception as e:
            print(f'Configuration error: {e}')
            exit(1)
        "

    - name: Test logging system
      run: |
        uv run python -c "
        from ai_task_notify_hook.logging import configure_logging, get_logger
        print('Testing logging system...')
        try:
            configure_logging()
            logger = get_logger('test')
            logger.info('Test log message', test_param='value')
            print('Logging system working')
        except Exception as e:
            print(f'Logging error: {e}')
            exit(1)
        "

  lint:
    name: Lint and Format Check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install uv
      uses: astral-sh/setup-uv@v6
      with:
        enable-cache: true
        cache-dependency-glob: |
          **/pyproject.toml
          **/uv.lock
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install dependencies
      run: uv sync --dev

    - name: Run Ruff linting
      run: uv run ruff check . --output-format=github

    - name: Run Ruff format check
      run: uv run ruff format --check .

    - name: Run mypy type checking
      run: uv run mypy components bases --strict

  security:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install uv
      uses: astral-sh/setup-uv@v6
      with:
        enable-cache: true
        cache-dependency-glob: |
          **/pyproject.toml
          **/uv.lock
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install dependencies
      run: uv sync --dev

    - name: Run Ruff security checks (S rules)
      run: uv run ruff check . --select S --output-format=github

    - name: Run Ruff all checks with statistics
      run: uv run ruff check . --statistics